<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Template Stage System</title>
<style>
body{margin:0;background:#0f172a;overflow:hidden;touch-action:none}
canvas{display:block}
.ui{position:absolute;inset:0;color:#fff;pointer-events:none;font-family:sans-serif}
.ui h2{margin:12px 0 0;text-align:center}
.ui p{text-align:center;opacity:.8}
.retry{position:absolute;bottom:20px;left:20px;background:#fff;color:#000;
padding:10px 22px;border-radius:20px;font-weight:bold;pointer-events:auto}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div class="ui">
  <h2 id="stName"></h2>
  <p id="stHint"></p>
  <div class="retry" onclick="resetStage()">RETRY</div>
</div>

<script>
/* ===== 基本 ===== */
const canvas=c;
const ctx=canvas.getContext("2d");
let W,H,time=0,stageIndex=0;

/* ===== ボール ===== */
const ball={
 x:0,y:0,r:13,baseR:13,
 vx:0,vy:0,
 moving:false,
 inHole:false,
 holeFall:false
};

/* ===== タッチ ===== */
const touch={a:false,sx:0,sy:0,cx:0,cy:0};

/* ===== テンプレ定義 ===== */
const TEMPLATES={
 BASIC:(lv)=>({
  name:`BASIC ${lv}`,
  hint:"狙って穴に落とそう",
  hole:{x:.8,w:80-lv*5,dyn:false},
  obs:[{t:"block",x:.5,y:.55,w:30,h:180}]
 }),

 MOVE:(lv)=>({
  name:`MOVE ${lv}`,
  hint:"タイミングを合わせよう",
  hole:{x:.8,w:70-lv*4,dyn:false},
  obs:[{t:"move",x:.3,y:.6,w:120,h:20,r:140,s:1+lv*.3}]
 }),

 COMBO:(lv)=>({
  name:`COMBO ${lv}`,
  hint:"組み合わせ",
  hole:{x:.75,w:65-lv*3,dyn:lv>2},
  obs:[
    {t:"block",x:.45,y:.55,w:30,h:160},
    {t:"move",x:.25,y:.65,w:120,h:20,r:150,s:1.5+lv*.2}
  ]
 })
};

/* ===== ステージ順 ===== */
const STAGE_FLOW=[
 ["BASIC",1],
 ["BASIC",2],
 ["MOVE",1],
 ["MOVE",2],
 ["COMBO",1],
 ["COMBO",2],
 ["COMBO",3]
];

/* ===== 現在のステージ ===== */
let stage;

/* ===== 生成 ===== */
function loadStage(){
 const [type,lv]=STAGE_FLOW[stageIndex%STAGE_FLOW.length];
 stage=TEMPLATES[type](lv);
 resetStage();
}

/* ===== リセット ===== */
function resetStage(){
 ball.x=80;
 ball.y=H*.8-ball.r-20;
 ball.vx=ball.vy=0;
 ball.moving=false;
 ball.inHole=false;
 ball.holeFall=false;
 stName.textContent=stage.name;
 stHint.textContent=stage.hint;
}

/* ===== リサイズ ===== */
function resize(){
 W=innerWidth;H=innerHeight;
 canvas.width=W;canvas.height=H;
 resetStage();
}

/* ===== 入力 ===== */
addEventListener("touchstart",e=>{
 if(!ball.moving){
  touch.a=true;
  touch.sx=touch.cx=e.touches[0].clientX;
  touch.sy=touch.cy=e.touches[0].clientY;
 }
},{passive:false});

addEventListener("touchmove",e=>{
 if(touch.a){
  touch.cx=e.touches[0].clientX;
  touch.cy=e.touches[0].clientY;
 }
 e.preventDefault();
},{passive:false});

addEventListener("touchend",()=>{
 if(touch.a){
  ball.vx=(touch.sx-touch.cx)*.13;
  ball.vy=(touch.sy-touch.cy)*.13;
  ball.moving=true;
  touch.a=false;
 }
});

/* ===== ループ ===== */
function loop(){
 time++;
 ctx.fillStyle="#0f172a";
 ctx.fillRect(0,0,W,H);

 const gY=H*.8;
 const holeW=stage.hole.w+(stage.hole.dyn?Math.sin(time*.07)*25:0);
 const holeX=W*stage.hole.x-holeW/2;
 const holeCX=holeX+holeW/2;

 /* 地面 */
 ctx.fillStyle="#10b981";
 ctx.fillRect(0,gY,W,H-gY);
 ctx.fillStyle="#000";
 ctx.fillRect(holeX,gY,holeW,120);

 /* 障害物 */
 stage.obs.forEach(o=>{
  if(o.t==="block"){
   ctx.fillStyle="#334155";
   ctx.fillRect(o.x*W-o.w/2,o.y*H-o.h/2,o.w,o.h);
  }
  if(o.t==="move"){
   const mx=o.x*W+Math.sin(time*.03*o.s)*o.r;
   ctx.fillStyle="#64748b";
   ctx.fillRect(mx-o.w/2,o.y*H-o.h/2,o.w,o.h);
   if(ball.y+ball.r>o.y*H-o.h/2 &&
      ball.y-ball.r<o.y*H+o.h/2 &&
      ball.x>mx-o.w/2 &&
      ball.x<mx+o.w/2){
        ball.y=o.y*H-o.h/2-ball.r;
        ball.vy=0;
   }
  }
 });

 /* 物理 */
 if(ball.moving && !ball.holeFall){
  ball.vy+=.5;
  ball.x+=ball.vx;
  ball.y+=ball.vy;

  if(ball.y+ball.r>gY){
   if(ball.x>holeX+ball.r*.4 && ball.x<holeX+holeW-ball.r*.4){
    ball.holeFall=true;
    ball.vx=0;
    ball.vy=2;
   }else{
    ball.y=gY-ball.r;
    ball.vy*=-.3;
    ball.vx*=.8;
   }
  }
 }

 /* 穴落下 */
 if(ball.holeFall){
  ball.x+=(holeCX-ball.x)*.1;
  ball.vy+=1.2;
  ball.y+=ball.vy;
 }

 /* 描画 */
 ctx.beginPath();
 ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
 ctx.fillStyle="#fff";
 ctx.fill();
 ctx.strokeStyle="#000";
 ctx.lineWidth=2;
 ctx.stroke();

 /* ステージクリア */
 if(ball.holeFall && ball.y>H+50){
  stageIndex++;
  loadStage();
 }

 requestAnimationFrame(loop);
}

/* ===== 初期化 ===== */
addEventListener("resize",resize);
resize();
loadStage();
loop();
</script>
</body>
</html>
